set global innodb_deadlock_detect=ON;
set innodb_lock_wait_timeout=3;
create table t1 (id int primary key) engine=innodb;
insert into t1 values (1),(2);
begin;
select * from t1 where id=1 for update;
id
1
set global innodb_deadlock_detect=ON;
set innodb_lock_wait_timeout=3;
select row_lock_deadlocks from information_schema.table_statistics where
table_name="t1";
row_lock_deadlocks
0
begin;
select * from t1 where id=2 for update;
id
2
select * from t1 where id=1 for update;
select * from t1 where id=2 for update;
ERROR 40001: Deadlock found when trying to get lock; try restarting transaction
rollback;
id
1
commit;
select row_lock_deadlocks from information_schema.table_statistics where
table_name="t1";
row_lock_deadlocks
1
select row_lock_deadlocks from information_schema.table_statistics where
table_name="t1";
row_lock_deadlocks
1
begin;
select * from t1 where id=1 for update;
id
1
begin;
select * from t1 where id=2 for update;
id
2
select * from t1 where id=2 for update;
select * from t1 where id=1 for update;
ERROR 40001: Deadlock found when trying to get lock; try restarting transaction
rollback;
id
2
select row_lock_deadlocks from information_schema.table_statistics where
table_name="t1";
row_lock_deadlocks
2
select row_lock_deadlocks from information_schema.table_statistics where
table_name="t1";
row_lock_deadlocks
2
drop table t1;
